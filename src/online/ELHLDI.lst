* Micro Focus Server Express         V5.1 revision 000 21-Jun-17 11:06 Page   1
* ELHLDI.cbl
* Options: int("ELHLDI.int") anim csi verbose NOBOUND LINKCHECK
*          PARAMCOUNTCHECK directives(cobopt.bth) endp list("ELHLDI.lst")
     1$SET SQL(dbman=ODBC, TARGETDB=MSSQLSERVER, NOAUTOCOMMIT)
* Setting: NOACCEPTREFRESH NOADV ALIGN"8" ALPHASTART"1" NOALTER NOAMODE ANIM
*          NOANIMPREP ANS85 APOST NOAREACHECK ARITHMETIC"OSVS" ASSIGN
*          "EXTERNAL" NOASSIGN-PRINTER NOAUTOLOCK NOBELL NOBOUND NOBRIEF
*          NOBS2000 BWZSTAR NOBYTEMODEMOVE CALLFH"EXTFH" NOCALLMCS
*          NOCALLRECOVERY CALLSORT"EXTSM" CANCEL CANCELLBR NOCHANGEMESSAGE
*          CHARSET"ASCII" CHECKDIV"ANSI" NOCHECKREFMOD NOCICS CICS-CPY
*          NOCICSOPTIMIZE NOCMPR2 NOCOBFSTATCONV NOCOBIDY NOCOBOL370 COBOLDIR
*          NOCOMP COMP-5"2" COMP-6"2" NOCOMS85 CONFIRM NOCONVERTRET CONVSPACE
*          COPYEXT",cbl,cpy" NOCOPYLBR COPYLIST COPYLISTCOMMENT"1" CSI
*          CURRENCY-SIGN"36" CURRENT-DATE"MMDDYY" NODATA DATACOMPRESS"0"
*          NODATA-CONTEXT DATE DBCHECK DBCS"2" NODBCSSOSI DBSPACE DE-EDIT"2"
*          DEFAULTBYTE"0" NODEFAULTCALLS DETECTLOCK NODG DIALECT"MF"
*          NODIRECTIVES-IN-COMMENTS NODOSVS NODPCINSUBSCRIPT DYNAM
*          NOEARLY-RELEASE ECHO NOECHOALL NOEDITOR ENSUITE"0" NOENTCOBOL
*          ERRFORMAT"1" ERRLIST"EMBED" NOERRQ FASTSORT NOFCD3 NOFCDREG
*          NOFDCLEAR NOFILESHARE FILETYPE"0" NOFLAG NOFLAGAS NOFLAGCD
*          NOFLAGEUC NOFLAGMIG NOFLAGQ FLAGSINEDIT NOFLAGSTD NOFOLDCALLNAME
*          NOFOLDCOPYNAME FORM"60" NOFP-ROUNDING NOHOSTARITHMETIC
*          NOHOSTCONTZERO NOHOST-NUMCOMPARE NOHOST-NUMMOVE NOHOSTFD NOHOSTRW
*          NOIBM-MS IBMCOMP IDXFORMAT"0" NOILGEN IMPLICITSCOPE NOINDD
*          INFORETURN"0" NOINITCALL INITPTR INT"ELHLDI.int" INTDATE"ANSI"
*          INTLEVEL"2" IOCONV NOISO2002 NOIXNLSKEY NOIXNUMKEY KEEP-INT
*          KEYCHECK KEYCOMPRESS"0" LIBRARIAN"2" NOLINE-COUNT LIST"ELHLDI.lst"
*          LISTPATH"" LISTWIDTH"80" LITVAL-SIZE"4" LOCKTYPE"0" NOMAPNAME
*          NOMAXERROR METHODDEFAULT"REFERENCE" MF"15" MFCOMMENT NOMOVELENCHECK
*          NOMS NOMVS NATIVE"ASCII" NONATIVEFLOATINGPOINT NONCHAR
*          NONEWBASENAME NONLS NSYMBOL"DBCS" NOODOOSVS NOODOSLIDE
*          NOOLDBLANKLINE NOOLDCOPY NOOLDINDEX NOOLDNEXTSENTENCE NOOLDREADINTO
*          NOOLDSTRMIX OOCTRL"-C-E-G-P+Q+R-S+W" OPTIONAL-FILE NOOS390 OSEXT""
*          NOOSVS NOOUTDD NOP64 NOPANVALET PERFORM-TYPE"OSVS" NOPREPLIST
*          NOPREPROCESS NOPRINT-EXT NOPROFILE NOPROGID-COMMENT
*          NOPROGID-INT-NAME NOPROTECT-LINKAGE PROTOTYPE"RELAXED" QUAL
*          QUALPROC NOQUERY NOQUOTE NORAWLIST NORDW RECMODE"F" NOREENTRANT
*          NOREF NOREFNO REMAINDER"1" REPORT-LINE"256" RESEQ NORETRYLOCK
*          REWRITE-LS NORM RTNCODE-SIZE"4" NORWHARDPAGE NOSAA SEG NOSEQCHK
*          SEQUENTIAL"RECORD" NOSERIAL SETTING"LINE" NOSHAREOUTDD NOSHOW-DIR
*          SIGN"ASCII" NOSIGNDISCARD NOSIGNFIXUP SORTTYPE"DFSORT" SOURCEFORMAT
*          "FIXED" SOURCETABSTOP"8" NOSPZERO NOSSRANGE STDERR STICKY-LINKAGE
*          "2" NOSTICKY-PERFORM SUPFF SWITCHTYPE"1" SYMBSTART"1" SYSPUNCH"132"
*          TERMPAGE TIME NOTRACE NOTRUNC NOTRUNCCALLNAME NOTRUNCCOPY TRUNCINC
*          "10" UNICODE"NATIVE" VERBOSE VSC2"4" WARNING"1" NOWB NOWB2 NOWB3
*          WEBSERVER"CGI" NOWRITELOCK NOWRITETHRU NOXOPEN NOXREF
*          NOZEROLENGTHFALSE NOZEROSEQ NOZWB
     2 identification division.
     3 program-id. ELHLDI.
     4******************************************************************
     5*                   C H A N G E   L O G
     6*
     7* CHANGES ARE MARKED BY THE CHANGE EFFECTIVE DATE.
     8*-----------------------------------------------------------------
     9*  CHANGE   CHANGE REQUEST PGMR  DESCRIPTION OF CHANGE
    10* EFFECTIVE    NUMBER
    11*-----------------------------------------------------------------
    12* 061517  CR               PEMA  ADD CHECK FOR CID1P VS. TEST
    13******************************************************************
* Micro Focus Server Express         V5.1 revision 000 21-Jun-17 11:06 Page   2
* ELHLDI.cbl
    14 environment division.
    15 INPUT-OUTPUT SECTION.
    16 FILE-CONTROL.
    17 SELECT file-in ASSIGN TO dynamic ws-file-in
    18    FILE STATUS IS ws-file-in-status
    19                            ORGANIZATION IS LINE SEQUENTIAL.
    20 data division.
    21 FILE SECTION.
    22 FD  file-in
    23     BLOCK CONTAINS 0
    24     RECORDING MODE F.
    25 01  file-in-rec                 pic x(200).
    26 working-storage section.
    27 01  DFH-START PIC X(04).
    28 77  s1 pic s999 comp-3 value +0.
    29 77  BYTE-OFFSET PIC S9(8) COMP VALUE +0.
    30 77  ws-eof-sw                   pic x  value spaces.
    31     88  end-of-input                  value 'Y'.
    32 77  ws-error-sw                 pic x  value spaces.
    33     88  error-found               value 'Y'.
    34 77  ws-sql-code                 pic s9(7) value zeros.
    35 77  ws-dis-sql-code             pic -9999999 value zeros.
    36 77  ws-string-len               pic s999 comp-3 value zeros.
    37 77  ws-vin-exists-sw            pic x value ' '.
    38     88  vin-exists                value 'Y'.
    39 01  P pointer.
    40 01  KIXSYS                      pic X(7)  VALUE Z"KIXSYS".
    41 01  var-ptr pointer.
    42 01  env-var-len                 pic 9(4)  binary.
    43 01  rc                          pic 9(9)  binary.
    44
    45 01  WS-KIXSYS.
    46     05  WS-KIX-FIL1             PIC X(10).
    47     05  WS-KIX-APPS             PIC X(10).
    48     05  WS-KIX-ENV              PIC X(10).
    49     05  WS-KIX-MYENV            PIC X(10).
    50     05  WS-KIX-SYS              PIC X(10).
    51 01  ws-xml-stuff.
    52     05  ws-fld-1                pic x(20) value spaces.
    53     05  ws-fld-2                pic x(20) value spaces.
    54     05  ws-fld-3                pic x(50) value spaces.
    55     05  ws-error-cd redefines
    56         ws-fld-3                pic 9.
    57     05  ws-len-of-5 redefines
    58         ws-fld-3                pic 9(5).
    59     05  ws-model-year redefines
    60         ws-fld-3                pic 9999.
    61     05  ws-base-price redefines
    62         ws-fld-3                pic 9(11).
    63     05  ws-fld-4                pic x(20) value spaces.
    64     05  ws-fld-5                pic x(20) value spaces.
    65 01  ws-misc.
    66     12  ws-file-in              pic x(26) value spaces.
    67     12  ws-connect-sw               pic x  value ' '.
    68         88  connected-to-db             value 'Y'.
    69     12  ws-file-in-status       pic xx  value spaces.
    70     12  ws-curl-return-cd       pic s9(8) comp-5 value +0.
    71     12  ws-curl-string.
* Micro Focus Server Express         V5.1 revision 000 21-Jun-17 11:06 Page   3
* ELHLDI.cbl
    72         16  f                   pic x(13) value
    73          'curl -o /tmp/'.
    74         16  filename-vin        pic x(17) value spaces.
    75         16  f                   pic xxxx value '.txt'.
    76         16  f                   pic x(63) value
    77          ' "http://www.iihs-hldi.org/vinxml/Vindicate.asmx/Vindic
    78-         'ate?Vin='.
    79         16  curl-vin            pic x(17).
    80         16  f                   pic x(18) value
    81          '&CCr=VKD0V7P7B7T1"'.
    82         16  f                   pic x value low-values.
*   83 EXEC SQL
*   84    INCLUDE SQLDA
*   85 END-EXEC
    86 01 SQLDA sync.
    87    05 SQLDAID               PIC X(8)  VALUE "SQLDA  ".
    88    05 SQLDABC               PIC S9(9) COMP-5 value 0.
    89    05 SQLN                  PIC S9(4) COMP-5 value 0.
    90    05 SQLD                  PIC S9(4) COMP-5 value 0.
    91    05 SQLVAR OCCURS 0 TO 1489 TIMES DEPENDING ON SQLD.
    92       10 SQLTYPE            PIC S9(4) COMP-5.
    93       10 SQLLEN             PIC S9(4) COMP-5.
    94$IF P64 SET
    95X      *> For 64-bit environments, ensure that SQLDATA is
    96X      *> aligned on an 8-byte boundary.
    97X      10 FILLER             PIC S9(9) COMP-5.
    98$END
    99       10 SQLDATA            USAGE POINTER.
   100       10 SQLIND             USAGE POINTER.
   101       10 SQLNAME.
   102          15 SQLNAMEL        PIC S9(4) COMP-5.
   103          15 SQLNAMEC        PIC X(30).
   104
   105* Values for SQLTYPE
   106
   107 78  ESQL-DATE-CHAR              VALUE 384.
   108 78  ESQL-DATE-CHAR-NULL         VALUE 385.
   109 78  ESQL-DATE-REC               VALUE 386.
   110 78  ESQL-DATE-REC-NULL          VALUE 387.
   111 78  ESQL-TIME-CHAR              VALUE 388.
   112 78  ESQL-TIME-CHAR-NULL         VALUE 389.
   113 78  ESQL-TIME-REC               VALUE 390.
   114 78  ESQL-TIME-REC-NULL          VALUE 391.
   115 78  ESQL-TIMESTAMP-CHAR         VALUE 392.
   116 78  ESQL-TIMESTAMP-CHAR-NULL    VALUE 393.
   117 78  ESQL-TIMESTAMP-REC          VALUE 394.
   118 78  ESQL-TIMESTAMP-REC-NULL     VALUE 395.
   119 78  ESQL-TS-OFFSET-CHAR         VALUE 396. *> added nx51sp1
   120 78  ESQL-TS-OFFSET-CHAR-NULL    VALUE 397.
   121 78  ESQL-TS-OFFSET-REC          VALUE 398.
   122 78  ESQL-TS-OFFSET-REC-NULL     VALUE 399. *> end adds nx51sp1
   123 78  ESQL-LONGVARBINARY          VALUE 404.
   124 78  ESQL-LONGVARBINARY-NULL     VALUE 405.
   125 78  ESQL-LONGVARCHAR            VALUE 408.
   126 78  ESQL-LONGVARCHAR-NULL       VALUE 409.
   127 78  ESQL-BINARY                 VALUE 444.
   128 78  ESQL-BINARY-NULL            VALUE 445.
   129 78  ESQL-VARBINARY              VALUE 446.
* Micro Focus Server Express         V5.1 revision 000 21-Jun-17 11:06 Page   4
* ELHLDI.cbl (/opt/lib/cobol/cpylib/sqlda.cpy)
   130 78  ESQL-VARBINARY-NULL         VALUE 447.
   131 78  ESQL-VARCHAR                VALUE 448.
   132 78  ESQL-VARCHAR-NULL           VALUE 449.
   133
   134 78  ESQL-CHARVARYING            VALUE 450.  *> added esq03n31
   135 78  ESQL-CHARVARYING-NULL       VALUE 451.  *> added esq03n31
   136
   137 78  ESQL-CHAR                   VALUE 452.
   138 78  ESQL-CHAR-NULL              VALUE 453.
   139
   140 78  ESQL-CHAR-FIXED             VALUE 454.  *> added esq03n31
   141 78  ESQL-CHAR-FIXED-NULL        VALUE 455.  *> added esq03n31
   142
   143 78  ESQL-DOUBLE                 VALUE 480.
   144 78  ESQL-DOUBLE-NULL            VALUE 481.
   145 78  ESQL-REAL                   VALUE 482.
   146 78  ESQL-REAL-NULL              VALUE 483.
   147 78  ESQL-DECIMAL                VALUE 484.
   148 78  ESQL-DECIMAL-NULL           VALUE 485.
   149 78  ESQL-INTEGER                VALUE 496.
   150 78  ESQL-INTEGER-NULL           VALUE 497.
   151 78  ESQL-SMALLINT               VALUE 500.
   152 78  ESQL-SMALLINT-NULL          VALUE 501.
   153 78  ESQL-TINYINT                VALUE 502.
   154 78  ESQL-TINYINT-NULL           VALUE 503.
*  155 EXEC SQL
*  156    INCLUDE SQLCA
*  157 END-EXEC
   158 01 SQLCA.
   159     05  SQLCAID         PIC X(8)         VALUE "SQLCA   ".
   160     05  SQLCABC         PIC S9(9) COMP-5 VALUE 136.
   161     05  SQLCODE         PIC S9(9) COMP-5 VALUE 0.
   162     05  SQLERRM.
   163         49  SQLERRML    PIC S9(4) COMP-5.
   164         49  SQLERRMC    PIC X(70).
   165     05  SQLERRP         PIC X(8).
   166     05  SQLERRD         PIC S9(9) COMP-5 OCCURS 6 VALUE 0.
   167     05  SQLWARN.
   168         10  SQLWARN0    PIC X.
   169         10  SQLWARN1    PIC X.
   170         10  SQLWARN2    PIC X.
   171         10  SQLWARN3    PIC X.
   172         10  SQLWARN4    PIC X.
   173         10  SQLWARN5    PIC X.
   174         10  SQLWARN6    PIC X.
   175         10  SQLWARN7    PIC X.
   176     05  SQLEXT.
   177         10  SQLWARN8    PIC X.
   178         10  SQLWARN9    PIC X.
   179         10  SQLWARN10   PIC X.
   180         10  SQLWARNA    REDEFINES SQLWARN10 PIC X .
   181     05  SQLSTATE    PIC X(5).
   182 EXEC SQL
   183    BEGIN DECLARE SECTION
   184 END-EXEC
   185 01  svr                         pic x(32).
   186 01  usr                         pic x(32).
   187 01  pass                        pic x(32).
* Micro Focus Server Express         V5.1 revision 000 21-Jun-17 11:06 Page   5
* ELHLDI.cbl
   188 01  usr-pass                    pic x(64).
   189 01  ws-disp-code                pic s9(11).
   190 01  ws-sql-record.
   191     05  ws-VIN                   pic x(17).
   192     05  ws-OutputVin             pic x(17).
   193     05  ws-ErrorCode             pic 9.
   194     05  ws-ErrorDesc             pic x(50).
   195     05  ws-CharSub               pic 9(5).
   196     05  ws-ModelYear             pic 9999.
   197     05  ws-MakeNumber            pic 9(5).
   198     05  ws-MakeName              pic x(50).
   199     05  ws-SeriesNumber          pic 9(5).
   200     05  ws-SeriesName            pic x(50).
   201     05  ws-ModelNumber           pic 9(5).
   202     05  ws-ModelName             pic x(50).
   203     05  ws-BodyStyleNumber       pic 9(5).
   204     05  ws-BodyStyleName         pic x(50).
   205     05  ws-CurbWeight            pic 9(5).
   206     05  ws-WheelBase             pic x(50).
   207     05  ws-Length                pic x(50).
   208     05  ws-Width                 pic x(50).
   209     05  ws-Height                pic x(50).
   210     05  ws-RestraintCode         pic 9(5).
   211     05  ws-RestraintDesc         pic x(50).
   212     05  ws-EngineNumber          pic 9(5).
   213     05  ws-EngineText            pic x(50).
   214     05  ws-HorsePowerMin         pic 9(5).
   215     05  ws-HorsePowerMax         pic 9(5).
   216     05  ws-ABSCode               pic 9(5).
   217     05  ws-VehicleType           pic 9(5).
   218     05  ws-TransNumber           pic 9(5).
   219     05  ws-TransDesc             pic x(50).
   220     05  ws-VehicleSizeID         pic 9(5).
   221     05  ws-VehicleSizeDesc       pic x(50).
   222     05  ws-VehicleClassID        pic 9(5).
   223     05  ws-VehicleClassDesc      pic x(50).
   224     05  ws-ATDDRLText            pic x(50).
   225     05  ws-ABSDescription        pic x(50).
   226     05  ws-BasePrice             pic 9(11).
   227     05  ws-InputVin              pic x(17).
   228 EXEC SQL
   229    END DECLARE SECTION
   230 END-EXEC
   231 01  WS-RESPONSE2                PIC S9(8) COMP VALUE +0.
   232 01  WS-RESPONSE                 PIC S9(8) COMP VALUE +0.
   233     88  RESP-NORMAL                    VALUE +0.
   234     88  resp-file-notfnd               value +12.
   235     88  RESP-NOTFND                    VALUE +13.
   236     88  resp-duprec                    value +14.
   237     88  resp-dupkey                    value +15.
   238     88  resp-invreq                    value +16.
   239     88  RESP-NOTOPEN                   VALUE +19.
   240     88  RESP-ENDFILE                   VALUE +20.
   241     88  resp-lengtherr                 value +22.
   242 01  msg-error.
   243     05  filler                  pic x(08) value ' error- '.
   244     05  me-response             pic 9(5)  value zeros.
   245     05  filler                  pic xx value spaces.
* Micro Focus Server Express         V5.1 revision 000 21-Jun-17 11:06 Page   6
* ELHLDI.cbl
   246     05  me-response2            pic 9(5)  value zeros.
   247     05  filler                  pic x(5)  value spaces.
   248     05  me-command              pic x(20) value spaces.
   249 01 MSG.
   250    03 FILLER                    PIC X(11) VALUE "Vindicator ".
   251    03 msg-vindicator            PIC x(1800)  value spaces.
   252 01  WS-PASS-AREa.
   253     03  PA-VIN                  PIC X(17).
   254     03  PA-ErrorCode            PIC X(10).
   255     03  PA-ErrorDesc            PIC X(30).
   256     03  PA-ModelYear            PIC 9(7).
   257     03  PA-MakeName             PIC X(50).
   258     03  PA-ModelName            PIC X(50).
   259     03  PA-SeriesName           PIC X(50).
   260****************************************************************
   261*
   262* Copyright (c) 2007-2013 Dell Inc.
   263* All rights reserved.
   264*
   265****************************************************************
   266 01  DFHEIV.
   267   02  DFHEIV0               PIC X(35).
   268   02  DFHEIV1               PIC X(08).
   269   02  DFHEIV2               PIC X(08).
   270   02  DFHEIV3               PIC X(08).
   271   02  DFHEIV4               PIC X(06).
   272   02  DFHEIV5               PIC X(04).
   273   02  DFHEIV6               PIC X(04).
   274   02  DFHEIV7               PIC X(02).
   275   02  DFHEIV8               PIC X(02).
   276   02  DFHEIV9               PIC X(01).
   277   02  DFHEIV10              PIC S9(7) COMP-3.
   278   02  DFHEIV11              PIC S9(4) COMP SYNC.
   279   02  DFHEIV12              PIC S9(4) COMP SYNC.
   280   02  DFHEIV13              PIC S9(4) COMP SYNC.
   281   02  DFHEIV14              PIC S9(4) COMP SYNC.
   282   02  DFHEIV15              PIC S9(4) COMP SYNC.
   283   02  DFHEIV16              PIC S9(9) COMP SYNC.
   284   02  DFHEIV17              PIC X(04).
   285   02  DFHEIV18              PIC X(04).
   286   02  DFHEIV19              PIC X(04).
   287   02  DFHEIV20              USAGE IS POINTER.
   288   02  DFHEIV21              USAGE IS POINTER.
   289   02  DFHEIV22              USAGE IS POINTER.
   290   02  DFHEIV23              USAGE IS POINTER.
   291   02  DFHEIV24              USAGE IS POINTER.
   292   02  DFHEIV25              PIC S9(9) COMP SYNC.
   293   02  DFHEIV26              PIC S9(9) COMP SYNC.
   294   02  DFHEIV27              PIC S9(9) COMP SYNC.
   295   02  DFHEIV28              PIC S9(9) COMP SYNC.
   296   02  DFHEIV29              PIC S9(9) COMP SYNC.
   297   02  DFHEIV30              PIC S9(9) COMP SYNC.
   298   02  DFHEIV31              PIC S9(9) COMP SYNC.
   299   02  DFHEIV32              PIC S9(4) COMP SYNC.
   300   02  DFHEIV33              PIC S9(4) COMP SYNC.
   301   02  DFHEIV34              PIC S9(4) COMP SYNC.
   302   02  DFHEIV35              PIC S9(4) COMP SYNC.
   303   02  DFHEIV97              PIC S9(7) COMP-3 VALUE ZERO.
* Micro Focus Server Express         V5.1 revision 000 21-Jun-17 11:06 Page   7
* ELHLDI.cbl
   304   02  DFHEIV98              PIC S9(4) COMP SYNC VALUE ZERO.
   305   02  FILLER                PIC X(02).
   306   02  DFHEIV99              PIC X(08) VALUE SPACE.
   307   02  DFHEIVL0              PIC X(48) VALUE SPACE.
   308   02  DFHEIVL1              PIC X(48) VALUE SPACE.
   309   02  DFHEIVL2              PIC X(48) VALUE SPACE.
   310   02  DFHEIVL3              PIC X(48) VALUE SPACE.
   311   02  DFHEIVL4              PIC X(255) VALUE SPACE.
   312   02  DFHEIVL5              PIC X(255) VALUE SPACE.
   313 LINKAGE  SECTION.
   314*****************************************************************
   315*                                                               *
   316* Copyright (c) 2007-2013 Dell Inc.                             *
   317* All rights reserved.                                          *
   318*                                                               *
   319*****************************************************************
   320 01  dfheiblk.
   321     02  eibtime          pic s9(7) comp-3.
   322     02  eibdate          pic s9(7) comp-3.
   323     02  eibtrnid         pic x(4).
   324     02  eibtaskn         pic s9(7) comp-3.
   325     02  eibtrmid         pic x(4).
   326     02  dfheigdi         pic s9(4) comp.
   327     02  eibcposn         pic s9(4) comp.
   328     02  eibcalen         pic s9(4) comp.
   329     02  eibaid           pic x(1).
   330     02  eibfiller1       pic x(1).
   331     02  eibfn            pic x(2).
   332     02  eibfiller2       pic x(2).
   333     02  eibrcode         pic x(6).
   334     02  eibfiller3       pic x(2).
   335     02  eibds            pic x(8).
   336     02  eibreqid         pic x(8).
   337     02  eibrsrce         pic x(8).
   338     02  eibsync          pic x(1).
   339     02  eibfree          pic x(1).
   340     02  eibrecv          pic x(1).
   341     02  eibsend          pic x(1).
   342     02  eibatt           pic x(1).
   343     02  eibeoc           pic x(1).
   344     02  eibfmh           pic x(1).
   345     02  eibcompl         pic x(1).
   346     02  eibsig           pic x(1).
   347     02  eibconf          pic x(1).
   348     02  eiberr           pic x(1).
   349     02  eibrldbk         pic x(1).
   350     02  eiberrcd         pic x(4).
   351     02  eibsynrb         pic x(1).
   352     02  eibnodat         pic x(1).
   353     02  eibfiller5       pic x(2).
   354     02  eibresp          pic s9(8) comp.
   355     02  eibresp2         pic s9(8) comp.
   356     02  dfheigdj         pic s9(4) comp.
   357     02  dfheigdk         pic s9(4) comp.
   358 01  DFHCOMMAREA                 PIC X(587).
   359 01  var  pic x(30).
   360 PROCEDURE DIVISION USING DFHEIBLK DFHCOMMAREA VAR.
   361 0000-DFHEXIT SECTION.
* Micro Focus Server Express         V5.1 revision 000 21-Jun-17 11:06 Page   8
* ELHLDI.cbl
   362     MOVE '9#                    $   ' TO DFHEIV0.
   363     MOVE 'ELHLDI' TO DFHEIV1.
   364     CALL 'kxdfhei1' USING DFHEIV0 DFH-START DFHEIV DFHEIV1.
   365     display ' entering program ELHLDIT'
   366     move dfhcommarea            to ws-pass-AREA
   367     set P to address of KIXSYS
   368     CALL "getenv" using by value P returning var-ptr
   369     if var-ptr = null then
   370        display ' kixsys not set '
   371     else
   372        set address of var to var-ptr
   373        move 0 to env-var-len
   374        inspect var tallying env-var-len
   375          for characters before X'00'
   376        unstring var (1:env-var-len) delimited by '/'
   377           into WS-KIX-FIL1 WS-KIX-APPS WS-KIX-ENV WS-KIX-MYENV
   378              WS-KIX-SYS
   379        end-unstring
   380     end-if
   381     perform 0010-init           thru 0010-exit
   382     perform 0020-exec-curl      thru 0020-exit
   383     perform 0030-get-hldi-data  thru 0030-exit
   384     perform 0050-bld-pass-area  thru 0050-exit
   385     .
   386 0000-return.
   387     move ws-pass-area           to dfhcommarea
   388
   389* exec cics return
   390*    end-exec
   391*    MOVE '.(                    ''   #00000291' TO DFHEIV0
   392     MOVE X'2E2820202020202020202020' TO DFHEIV0(1:12)
   393     MOVE X'202020202020202020202720' TO DFHEIV0(13:12)
   394     MOVE X'2020233030303030323931' TO DFHEIV0(25:11)
   395     CALL 'kxdfhei1' USING DFHEIV0,
   396           DFHEIV99,
   397           DFHEIV99,
   398           DFHEIV99,
   399           DFHEIV99,
   400           DFHEIV99,
   401           DFHEIV99
   402     GO TO 9999-DFHEXIT DEPENDING ON DFHEIGDK
   403
   404* GOBACK
   405
   406     MOVE '9%                    "   ' TO DFHEIV0
   407     MOVE 'ELHLDI' TO DFHEIV1
   408     CALL 'kxdfhei1' USING DFHEIV0 DFHEIV1
   409     GOBACK
   410     .
   411 0010-init.
   412     move pa-vin                 to filename-vin
   413                                    curl-vin
   414     .
   415 0010-exit.
   416     exit.
   417 0020-exec-curl.
   418     display ' curl string **' ws-curl-string '**'
   419     call "SYSTEM" using ws-curl-string
* Micro Focus Server Express         V5.1 revision 000 21-Jun-17 11:06 Page   9
* ELHLDI.cbl
   420        returning ws-curl-return-cd
   421     display ' curl  return code ' ws-curl-return-cd
   422     if ws-curl-return-cd not = zeros
   423        display ' error curl ' ws-curl-return-cd
   424        display ' Vin =      ' ws-vin
   425        move '8'                 to pa-errorcode
   426        go to 0000-return
   427     end-if
   428     .
   429 0020-exit.
   430     exit.
   431 0030-get-hldi-data.
   432     string
   433        '/tmp/'
   434        filename-vin
   435        '.txt' delimited by size into ws-file-in
   436     end-string
   437     open input file-in
   438     if ws-file-in-status not = '00'
   439        display 'error open filein  ' ws-file-in-status
   440        move '8'                 to pa-errorcode
   441        go to 0000-return
   442     end-if
   443     perform 0105-read-input     thru 0105-exit
   444     If ws-file-in-status not = '00'
   445        Display 'Read failed, file status: '  ws-file-in-status
   446        move '8'                 to pa-errorcode
   447        go to 0000-return
   448     End-if
   449     move pa-vin                 to ws-vin
   450     perform 0120-process-xml    thru 0120-exit until
   451        end-of-input or error-found
   452     close file-in
   453*    if not connected-to-db
   454*       perform 1000-connect-db  thru 1000-exit
   455*    end-if
   456*    EXEC SQL
   457*       DELETE FROM HLDI
   458*       WHERE VIN = :WS-VIN
   459*    END-EXEC
   460*    if sqlcode not = 0
   461*       display "Error: delete  " ws-vin
   462*       display ' sql return code ' sqlcode
   463*       display ' sql err mess    ' sqlerrmc
   464*    end-if
   465     perform 0140-check-if-exist thru 0140-exit
   466     if vin-exists
   467        perform 0145-update-row  thru 0145-exit
   468     else
   469        perform 0130-insert-row  thru 0130-exit
   470     end-if
   471     if connected-to-db
   472        EXEC SQL
   473            commit work release
   474        END-EXEC
   475        if sqlcode not = 0
   476           display "Error: commit release "
   477           display ' sql return code ' sqlcode
* Micro Focus Server Express         V5.1 revision 000 21-Jun-17 11:06 Page  10
* ELHLDI.cbl
   478           display ' sql err mess    ' sqlerrmc
   479        end-if
   480     end-if
   481     if connected-to-db
   482        EXEC SQL
   483            disconnect all
   484        END-EXEC
   485        move ' ' to ws-connect-sw
   486     end-if
   487     .
   488 0030-exit.
   489     exit.
   490 0105-read-input.
   491      Read file-in end
   492         set end-of-input to true
   493      end-read
   494     .
   495 0105-exit.
   496     exit.
   497 0120-process-xml.
   498     display ' processing record ' file-in-rec
   499     unstring file-in-rec
   500        delimited by '<' or '>'
   501        into ws-fld-1
   502           ws-fld-2
   503           ws-fld-3
   504           ws-fld-4
   505           ws-fld-5
   506     end-unstring
   507*    display ' fld 1 ' ws-fld-1
   508*    display ' fld 2 ' ws-fld-2
   509*    display ' fld 3 ' ws-fld-3
   510*    display ' fld 4 ' ws-fld-4
   511*    display ' fld 5 ' ws-fld-5
   512     perform 0125-calc-field-len thru 0125-exit
   513     evaluate ws-fld-2
   514        when 'OutputVIN'
   515           move ws-fld-3         to ws-outputvin
   516        when 'ErrorCode'
   517           display ' found error code ' ws-fld-3
   518           inspect ws-fld-3 (1:1) replacing all spaces by zeros
   519           move ws-error-cd      to ws-errorcode
   520           if ws-error-cd <> '0'
   521              set error-found to true
   522           end-if
   523        when 'ErrorDesc'
   524           move ws-fld-3         to ws-errordesc
   525        when 'CharSub'
   526           move ws-fld-3 (1:ws-string-len)
   527                                 to ws-charsub
   528        when 'ModelYear'
   529           move ws-fld-3 (1:ws-string-len)
   530                                 to ws-modelyear
   531        when 'MakeNumber'
   532           move ws-fld-3 (1:ws-string-len)
   533                                 to ws-makenumber
   534        when 'MakeName'
   535           move ws-fld-3         to ws-makename
* Micro Focus Server Express         V5.1 revision 000 21-Jun-17 11:06 Page  11
* ELHLDI.cbl
   536        when 'SeriesNumber'
   537           move ws-fld-3 (1:ws-string-len)
   538                                 to ws-seriesnumber
   539        when 'SeriesName'
   540           move ws-fld-3         to ws-seriesname
   541        when 'ModelNumber'
   542           move ws-fld-3 (1:ws-string-len)
   543                                 to ws-modelnumber
   544        when 'ModelName'
   545           move ws-fld-3         to ws-modelname
   546        when 'BodyStyleNumber'
   547           move ws-fld-3 (1:ws-string-len)
   548                                 to ws-bodystylenumber
   549        when 'BodyStyleName'
   550           move ws-fld-3         to ws-bodystylename
   551        when 'CurbWeight'
   552           move ws-fld-3 (1:ws-string-len)
   553                                 to ws-curbweight
   554        when 'Wheelbase'
   555           move ws-fld-3 (1:ws-string-len)
   556                                 to ws-wheelbase
   557        when 'Length'
   558           move ws-fld-3 (1:ws-string-len)
   559                                 to ws-length
   560        when 'Width'
   561           move ws-fld-3 (1:ws-string-len)
   562                                 to ws-width
   563        when 'Height'
   564           move ws-fld-3 (1:ws-string-len)
   565                                 to ws-height
   566        when 'RestraintCode'
   567           move ws-fld-3 (1:ws-string-len)
   568                                 to ws-restraintcode
   569        when 'RestraintDesc'
   570           move ws-fld-3         to ws-restraintdesc
   571        when 'EngineNumber'
   572           move ws-fld-3 (1:ws-string-len)
   573                                 to ws-enginenumber
   574        when 'EngineText'
   575           move ws-fld-3         to ws-enginetext
   576        when 'HorsepowerMin'
   577           move ws-fld-3 (1:ws-string-len)
   578                                 to ws-horsepowermin
   579        when 'HorsepowerMax'
   580           move ws-fld-3 (1:ws-string-len)
   581                                 to ws-horsepowermax
   582        when 'ABSCode'
   583           move ws-fld-3 (1:ws-string-len)
   584                                 to ws-abscode
   585        when 'VehicleType'
   586           move ws-fld-3 (1:ws-string-len)
   587                                 to ws-vehicletype
   588        when 'TransNumber'
   589           move ws-fld-3 (1:ws-string-len)
   590                                 to ws-transnumber
   591        when 'TransDesc'
   592           move ws-fld-3         to ws-transdesc
   593        when 'VehicleSizeID'
* Micro Focus Server Express         V5.1 revision 000 21-Jun-17 11:06 Page  12
* ELHLDI.cbl
   594           move ws-fld-3 (1:ws-string-len)
   595                                 to ws-vehiclesizeid
   596        when 'VehicleSizeDesc'
   597           move ws-fld-3         to ws-vehiclesizedesc
   598        when 'VehicleClassID'
   599           move ws-fld-3 (1:ws-string-len)
   600                                 to ws-vehicleclassid
   601        when 'VehicleClassDesc'
   602           move ws-fld-3         to ws-vehicleclassdesc
   603        when 'ATD_DRLText'
   604           move ws-fld-3         to ws-atddrltext
   605        when 'ABSDescription'
   606           move ws-fld-3         to ws-absdescription
   607        when 'BasePrice'
   608           move ws-fld-3 (1:ws-string-len)
   609                                 to ws-baseprice
   610        when 'InputVIN'
   611           move ws-fld-3         to ws-inputvin
   612        when other
   613           display ' no worries ' ws-fld-2 ' ' ws-fld-3
   614     end-evaluate
   615     perform 0105-read-input     thru 0105-exit
   616     .
   617 0120-exit.
   618     exit.
   619 0125-calc-field-len.
   620     move 0                      to ws-string-len
   621     inspect ws-fld-3 tallying ws-string-len for all ' '
   622*    display ' string len b4 ' ws-string-len
   623     compute ws-string-len = 50 - ws-string-len
   624*    display ' string len af ' ws-string-len
   625     .
   626 0125-exit.
   627     exit.
   628 0130-insert-row.
   629     if not connected-to-db
   630        perform 1000-connect-db  thru 1000-exit
   631     end-if
   632     EXEC SQL
   633        INSERT into HLDI (
   634           VIN
   635          ,OutputVin
   636          ,ErrorCode
   637          ,ErrorDesc
   638          ,CharSub
   639          ,ModelYear
   640          ,MakeNumber
   641          ,MakeName
   642          ,SeriesNumber
   643          ,SeriesName
   644          ,ModelNumber
   645          ,ModelName
   646          ,BodyStyleNumber
   647          ,BodyStyleName
   648          ,CurbWeight
   649          ,WheelBase
   650          ,Length
   651          ,Width
* Micro Focus Server Express         V5.1 revision 000 21-Jun-17 11:06 Page  13
* ELHLDI.cbl
   652          ,Height
   653          ,RestraintCode
   654          ,RestraintDesc
   655          ,EngineNumber
   656          ,EngineText
   657          ,HorsePowerMin
   658          ,HorsePowerMax
   659          ,ABSCode
   660          ,VehicleType
   661          ,TransNumber
   662          ,TransDesc
   663          ,VehicleSizeID
   664          ,VehicleSizeDesc
   665          ,VehicleClassID
   666          ,VehicleClassDesc
   667          ,ATDDRLText
   668          ,ABSDescription
   669          ,BasePrice
   670          ,InputVin)
   671         VALUES (
   672          :ws-VIN
   673          ,:ws-OutputVin
   674          ,:ws-ErrorCode
   675          ,:ws-ErrorDesc
   676          ,:ws-CharSub
   677          ,:ws-ModelYear
   678          ,:ws-MakeNumber
   679          ,:ws-MakeName
   680          ,:ws-SeriesNumber
   681          ,:ws-SeriesName
   682          ,:ws-ModelNumber
   683          ,:ws-ModelName
   684          ,:ws-BodyStyleNumber
   685          ,:ws-BodyStyleName
   686          ,:ws-CurbWeight
   687          ,:ws-WheelBase
   688          ,:ws-Length
   689          ,:ws-Width
   690          ,:ws-Height
   691          ,:ws-RestraintCode
   692          ,:ws-RestraintDesc
   693          ,:ws-EngineNumber
   694          ,:ws-EngineText
   695          ,:ws-HorsePowerMin
   696          ,:ws-HorsePowerMax
   697          ,:ws-ABSCode
   698          ,:ws-VehicleType
   699          ,:ws-TransNumber
   700          ,:ws-TransDesc
   701          ,:ws-VehicleSizeID
   702          ,:ws-VehicleSizeDesc
   703          ,:ws-VehicleClassID
   704          ,:ws-VehicleClassDesc
   705          ,:ws-ATDDRLText
   706          ,:ws-ABSDescription
   707          ,:ws-BasePrice
   708          ,:ws-InputVin)
   709     end-exec
* Micro Focus Server Express         V5.1 revision 000 21-Jun-17 11:06 Page  14
* ELHLDI.cbl
   710     if sqlcode not = 0
   711        display "Error: cannot insert row "
   712        display ' sql return code ' sqlcode
   713        move sqlcode to ws-sql-code
   714        move ws-sql-code to ws-dis-sql-code
   715        display ' dis sql code ' ws-dis-sql-code
   716        display ' sql err mess    ' sqlerrmc
   717     end-if
   718     .
   719 0130-exit.
   720     exit.
   721 0140-check-if-exist.
   722     if not connected-to-db
   723        perform 1000-connect-db  thru 1000-exit
   724     end-if
   725     EXEC SQL
   726        SELECT OutputVin
   727        INTO   :ws-outputvin
   728        FROM   HLDI
   729        WHERE  VIN = :WS-VIN
   730     END-EXEC
   731     move sqlcode to ws-dis-sql-code
   732     display ' code after select ' ws-dis-sql-code
   733     if sqlcode = 0
   734        display ' found vin ' ws-vin
   735        set vin-exists to true
   736     else
   737        display "Error: cannot select row "
   738        display ' sql return code ' sqlcode
   739        move sqlcode to ws-sql-code
   740        move ws-sql-code to ws-dis-sql-code
   741        display ' dis sql code ' ws-dis-sql-code
   742        display ' sql err mess    ' sqlerrmc
   743     end-if
   744     .
   745 0140-exit.
   746     exit.
   747 0145-update-row.
   748     display ' About to Update row ' ws-vin
   749     EXEC SQL
   750        UPDATE HLDI SET
   751           OutputVin          = :ws-OutputVin
   752          ,ErrorCode          = :ws-ErrorCode
   753          ,ErrorDesc          = :ws-ErrorDesc
   754          ,CharSub            = :ws-CharSub
   755          ,ModelYear          = :ws-ModelYear
   756          ,MakeNumber         = :ws-MakeNumber
   757          ,MakeName           = :ws-MakeName
   758          ,SeriesNumber       = :ws-SeriesNumber
   759          ,SeriesName         = :ws-SeriesName
   760          ,ModelNumber        = :ws-ModelNumber
   761          ,ModelName          = :ws-ModelName
   762          ,BodyStyleNumber    = :ws-BodyStyleNumber
   763          ,BodyStyleName      = :ws-BodyStyleName
   764          ,CurbWeight         = :ws-CurbWeight
   765          ,WheelBase          = :ws-WheelBase
   766          ,Length             = :ws-Length
   767          ,Width              = :ws-Width
* Micro Focus Server Express         V5.1 revision 000 21-Jun-17 11:06 Page  15
* ELHLDI.cbl
   768          ,Height             = :ws-Height
   769          ,RestraintCode      = :ws-RestraintCode
   770          ,RestraintDesc      = :ws-RestraintDesc
   771          ,EngineNumber       = :ws-EngineNumber
   772          ,EngineText         = :ws-EngineText
   773          ,HorsePowerMin      = :ws-HorsePowerMin
   774          ,HorsePowerMax      = :ws-HorsePowerMax
   775          ,ABSCode            = :ws-ABSCode
   776          ,VehicleType        = :ws-VehicleType
   777          ,TransNumber        = :ws-TransNumber
   778          ,TransDesc          = :ws-TransDesc
   779          ,VehicleSizeID      = :ws-VehicleSizeID
   780          ,VehicleSizeDesc    = :ws-VehicleSizeDesc
   781          ,VehicleClassID     = :ws-VehicleClassID
   782          ,VehicleClassDesc   = :ws-VehicleClassDesc
   783          ,ATDDRLText         = :ws-ATDDRLText
   784          ,ABSDescription     = :ws-ABSDescription
   785          ,BasePrice          = :ws-BasePrice
   786          ,InputVin           = :ws-InputVin
   787         WHERE VIN = :WS-VIN
   788     end-exec
   789     if sqlcode not = 0
   790        display "Error: cannot update row "
   791        display ' sql return code ' sqlcode
   792        move sqlcode to ws-sql-code
   793        move ws-sql-code to ws-dis-sql-code
   794        display ' dis sql code ' ws-dis-sql-code
   795        display ' sql err mess    ' sqlerrmc
   796     end-if
   797     .
   798 0145-exit.
   799     exit.
   800 0050-bld-pass-area.
   801     move ws-errorcode           to pa-errorcode
   802     move ws-errordesc           to pa-errordesc
   803     move ws-modelyear           to pa-modelyear
   804     move ws-makename            to pa-makename
   805     move ws-modelname           to pa-modelname
   806     move ws-seriesname          to pa-seriesname
   807     .
   808 0050-exit.
   809     exit.
   810 1000-CONNECT-DB.
   811     move 'NTSQLTST2_Logic'      to svr
   812     move 'sa'                   to usr
   813     move 'sql2008r2'            to pass
   814     if ws-kix-myenv = 'cid1p'
   815        move 'NTCSO2_Logic'      to svr
   816        move 'sa'                to usr
   817        move 'ntcso2'            to pass
   818     end-if
   819     string
   820         usr delimited space
   821         "." delimited size
   822         pass delimited space into usr-pass
   823     end-string
   824     EXEC SQL
   825        CONNECT TO :svr USER :usr-pass
* Micro Focus Server Express         V5.1 revision 000 21-Jun-17 11:06 Page  16
* ELHLDI.cbl
   826     END-EXEC
   827     if sqlcode not = 0
   828        move '8'                 to pa-errorcode
   829        display "Error: cannot connect "
   830        display sqlcode
   831        display sqlerrmc
   832        go to 0000-return
   833     else
   834        set connected-to-db to true
   835     end-if
   836     .
   837 1000-EXIT.
   838     EXIT.
   839
   840 9999-DFHBACK SECTION.
   841     MOVE '9%                    "   ' TO DFHEIV0
   842     MOVE 'ELHLDI' TO DFHEIV1
   843     CALL 'kxdfhei1' USING DFHEIV0 DFHEIV1
   844     GOBACK.
   845 9999-DFHEXIT.
   846     IF DFHEIGDJ EQUAL 0001
   847         NEXT SENTENCE.
   848     MOVE '9%                    "   ' TO DFHEIV0
   849     MOVE 'ELHLDI' TO DFHEIV1
   850     CALL 'kxdfhei1' USING DFHEIV0 DFHEIV1
   851     GOBACK.
* Micro Focus Server Express         V5.1 revision 000 Compiler
* Copyright (C) Micro Focus IP Development Limited 1984-2012.
*                                                        REF GNR-008065005AF
* Total Messages:     0
* Data:      137776     Code:       13951
